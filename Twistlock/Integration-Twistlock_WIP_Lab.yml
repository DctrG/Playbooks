commonfields:
  id: Twistlock_WIP_Lab
  version: -1
name: Twistlock_WIP_Lab
display: Twistlock_WIP_Lab
category: Endpoint
image: data:image/png;base64,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
configuration:
- display: Server
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Port
  name: port
  defaultvalue: "8081"
  type: 0
  required: true
- display: User
  name: user
  defaultvalue: ""
  type: 0
  required: false
- display: Password
  name: password
  defaultvalue: ""
  type: 4
  required: false
- display: Token
  name: token
  defaultvalue: ""
  type: 12
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
script:
  script: |-
    import requests
    from requests.auth import HTTPBasicAuth
    import json
    import base64
    import datetime
    from datetime import datetime, timedelta

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBALS '''
    VERBOSE = True
    SERVER = demisto.params().get('server')
    PORT = demisto.params().get('port')
    USER = demisto.params().get('user')
    PASSWORD = demisto.params().get('password')
    TOKEN = demisto.params().get('token')
    AUTH = HTTPBasicAuth(USER, PASSWORD)


    PARAMS = {
        'format' : 'json'
        }


    if demisto.command() == 'test-module':
        res = requests.get(f'{SERVER}:{PORT}/api/v1/_ping', auth=AUTH)
        if res.text == 'OK':
            demisto.results("ok")
            sys.exit(0)
        else:
            sys.exit(1)

    if demisto.command() == 'fetch-incidents':
        start_time = datetime.utcnow() - timedelta(minutes = 1)

        incidents = []
        res = requests.get(f'{SERVER}:{PORT}/api/v1/audits/runtime/container/download',
                                                                   stream = True,
                                                                   auth = AUTH,
                                                                   params = PARAMS)

        for line in res.iter_lines():
            audit = json.loads(line)
            audit_time = datetime.strptime(audit['date'], "%Y-%m-%dT%H:%M:%S.%fZ")
            # if audit_time > start_time and audit_time < start_time + timedelta(minutes = 5):
            if audit_time > start_time:
                audit["api"] = '/api/v1/audits/runtime/container/download'
                incidents.append({'name': "Twistlock Container: " + audit['attack'],
                                  'occurred': audit['date'],
                                  'rawJSON': json.dumps(audit)
                                  })

        demisto.incidents(incidents)
        sys.exit(0)

    if demisto.command() == 'twistlock-get-container-scan-report':

        containerID = demisto.args().get('container-name')

        # r = requests.get(f'{SERVER}:{PORT}/api/v1/containers?id={containerID}',
        r = requests.get(f'{SERVER}:{PORT}/api/v1/containers?name={containerID}',
                                                                  stream = True,
                                                                  params = PARAMS,
                                                                  auth = AUTH)
        for line in r.iter_lines():
            audit = json.loads(line)
            data = audit[0]['info']['complianceVulnerabilities']
            context_list = []
            table = []
            pretable = {}
            for element in data:
                if element['severity'] in ("critical", "high"):
                    pretable[element['title']] = element['description']
                    context_list.insert(0, {'title': element['title'], 'description': element['description']})

            table.append(pretable)

            context = {
                'containerscanresult': context_list
            }
            demisto.results({'ContentsFormat': formats['table'], 'Type': entryTypes['note'], 'Contents': table, 'EntryContext' : context})
        sys.exit(0)
  type: python
  commands:
  - name: twistlock-get-container-scan-report
    arguments:
    - name: container-name
    outputs:
    - contextPath: VulnScan.Title
      description: Title
      type: string
    - contextPath: VulnScan.Description
      description: Description
      type: string
  - name: fetch-incidents
    arguments: []
  dockerimage: demisto/python3:3.7.4.977
  isfetch: true
  runonce: false
  subtype: python3
sourcemoduleid: Twistlock
