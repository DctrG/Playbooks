commonfields:
  id: Twistlock_G
  version: -1
name: Twistlock_G
display: Twistlock_G
category: Endpoint
image: data:image/png;base64,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
configuration:
- display: Server URL
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Port
  name: port
  defaultvalue: "8081"
  type: 0
  required: true
- display: User
  name: user
  defaultvalue: ""
  type: 0
  required: true
- display: Password
  name: password
  defaultvalue: ""
  type: 0
  required: true
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Trust any certificate (insecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |+
    import requests
    import json
    import base64
    from datetime import datetime
    import re

    requests.packages.urllib3.disable_warnings()

    ''' GLOBALS/PARAMS '''

    params = demisto.params()
    USE_SSL = not params.get('insecure', False)
    SERVER = params['url'][:-1] if (params['url'] and params['url'].endswith('/')) else params['url']
    PORT = params['port']
    BASE_URL = f'{SERVER}:{PORT}'
    USER = params['user']
    PASSWORD = params['password']
    AUTH = "Basic " + base64.b64encode(f'{USER}:{PASSWORD}'.encode()).decode()
    if 'container-id' in demisto.args():
        CONTAINER = demisto.args()['container-id']
    if 'image-id' in demisto.args():
        IMAGE = demisto.args()['image-id']
    HEADERS = {
        'Authorization': AUTH
    }

    if not demisto.params()['proxy']:
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    def http_request(method, url_sufix, params=None, headers=HEADERS, parse_json=True):
        url = BASE_URL + url_sufix
        if params:
            params['format'] = 'json'
        try:
            res = requests.request(
                method,
                url,
                verify=USE_SSL,
                params=params,
                headers=HEADERS
                )
        except requests.exceptions.RequestException as e:
            LOG(str(e))
            return_error('Error in connection to the server. Please make sure you entered the URL correctly.')
        if res.status_code not in [200, 201]:
            if res.status_code == 401:
                reason = 'Unauthorized. Please check your credentials'
            else:
                try:
                    reason = res.json()
                except ValueError:
                    reason = res.reason
            return_error(f'Error in API call status code: {res.status_code}, reason: {reason}')

        if parse_json:
            return res.json()
        return res

    def prepare_results(res, contextkey):
        return demisto.results({'ContentsFormat': formats['table'], 'Type': entryTypes['note'], 'Contents': res, 'EntryContext': {contextkey: [e for e in res]}})

    @logger
    def fetch_incidents():
        last_run = demisto.getLastRun()
        day_ago = datetime.utcnow() - timedelta(days=1)
        start_time = day_ago.strftime("%Y-%m-%dT%H:%M:%S.%fZ")
        if last_run and 'start_time' in last_run:
            start_time = last_run.get('start_time')

        params = {'from': start_time}
        audit = http_request('GET', '/api/v1/audits/incidents', params)
        incidents = []
        try:
            if audit:
                for element in audit:
                    element['api'] = '/api/v1/audits/incidents'
                    incident = {
                              'name': f"Twistlock Incident. Container: {element['containerName']}. Category: {element['category']}",
                              'occurred': element['time'],
                              'rawJSON': json.dumps(element)
                    }
                    incidents.append(incident)
        except ValueError as e:
             LOG(str(e))

        demisto.setLastRun({
            'start_time': datetime.utcnow().isoformat('T') + 'Z'
        })
        demisto.incidents(incidents)

    def test_module():
        res = http_request('GET', '/api/v1/_ping', parse_json=False)
        if res.text == 'OK':
            return "ok"

    def twistlock_get_container_scan_results():
        scan = http_request('GET', '/api/v1/containers', params={'name': CONTAINER})
        print(scan)
        res = []
        for element in scan:
            if element['info']['name'] == f'{CONTAINER}':
                for entry in element['info']['complianceIssues']:
                    title = re.sub('\(.{1,}\)', '', entry['title'])
                    res.insert(0, {'title': title, 'description': entry['description'].replace('\n', '')})
        prepare_results(res, 'scanresults')

    def twistlock_get_image_scan_results():
        scan = http_request('GET', '/api/v1/images', params={'image': IMAGE})
        res = []
        for element in scan:
            if element['id'] == f'{IMAGE}':
                for entry in element['vulnerabilities']:
                    if entry['severity'] in ['high', 'critical']:
                        res.insert(0, {'title': entry['cve'], 'severity': entry['severity'], 'package': entry['packageName'], 'description': entry['description'].replace('\n', '')})
        prepare_results(res, 'imagescanresults')

    def twistlock_get_container_alerts():
        scan = http_request('GET', '/api/v1/audits/runtime/container', params={'name': CONTAINER} )
        res  = [{'type': entry} for element in scan for entry in element['audits']]
        prepare_results(res, 'containeralerts')

    if demisto.command() == 'fetch-incidents':
        fetch_incidents()
    if demisto.command() == 'test-module':
        test_module()
        demisto.results('ok')
    if demisto.command() == 'twistlock-get-container-scan-results':
        twistlock_get_container_scan_results()
    if demisto.command() == 'twistlock-get-image-scan-results':
        twistlock_get_image_scan_results()
    if demisto.command() == 'twistlock-get-container-alerts':
        twistlock_get_container_alerts()


  type: python
  commands:
  - name: twistlock-get-container-scan-results
    arguments:
    - name: container-id
      defaultValue: none
  - name: twistlock-get-image-scan-results
    arguments:
    - name: image-id
  - name: twistlock-get-container-alerts
    arguments:
    - name: container-id
  dockerimage: demisto/python3:3.7.4.977
  isfetch: true
  runonce: false
  subtype: python3
sourcemoduleid: Twistlock
